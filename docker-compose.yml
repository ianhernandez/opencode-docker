services:
  opencode:
    build:
      context: .
      dockerfile: Dockerfile.opencode
    container_name: opencode-server
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - ./workspace:/workspace
    ports:
      - 4096
    networks:
      - dokploy-network
    restart: unless-stopped

  preview:
    build:
      context: .
      dockerfile: Dockerfile.preview
    container_name: preview
    volumes:
      - ./workspace:/usr/share/nginx/html:ro
    ports:
      - 80
    networks:
      - dokploy-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.opencode-preview.rule=Host(`preview.yourdomain.com`)"
      - "traefik.http.routers.opencode-preview.entrypoints=websecure"
      - "traefik.http.routers.opencode-preview.tls.certResolver=letsencrypt"
      - "traefik.http.services.opencode-preview.loadbalancer.server.port=80"

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: backend
    environment:
      - OPENCODE_URL=http://opencode:4096
      - PORT=3000
    volumes:
      - ./workspace:/workspace
    ports:
      - 3000
    networks:
      - dokploy-network
    depends_on:
      - opencode
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.opencode-backend.rule=Host(`api.yourdomain.com`)"
      - "traefik.http.routers.opencode-backend.entrypoints=websecure"
      - "traefik.http.routers.opencode-backend.tls.certResolver=letsencrypt"
      - "traefik.http.services.opencode-backend.loadbalancer.server.port=3000"

networks:
  dokploy-network:
    external: true
